from fastapi import FastAPI, UploadFile, File
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse
import pdfplumber, re, io
from typing import List

app = FastAPI(title="Alpaca Tax Analyzer")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"], allow_methods=["*"], allow_headers=["*"]
)

MONTH_MAP = {
    "JANUARY":1,"FEBRUARY":2,"MARCH":3,"APRIL":4,"MAY":5,"JUNE":6,
    "JULY":7,"AUGUST":8,"SEPTEMBER":9,"OCTOBER":10,"NOVEMBER":11,"DECEMBER":12
}

def pn(s):
    try: return float(s.replace(",","").replace(" ",""))
    except: return 0.0

def parse_pdf(content: bytes) -> dict:
    r = dict(period=None,year=None,month=None,month_num=None,
             additions=0.0,subtractions=0.0,ending_cash=0.0,total_market_value=0.0,
             dividend_period=0.0,dividend_ytd=0.0,
             st_gain_period=0.0,st_loss_period=0.0,st_net_period=0.0,
             lt_gain_period=0.0,lt_loss_period=0.0,lt_net_period=0.0,
             st_gain_ytd=0.0,st_loss_ytd=0.0,st_net_ytd=0.0,
             lt_gain_ytd=0.0,lt_loss_ytd=0.0,lt_net_ytd=0.0,
             withholding_tax_period=0.0,total_net_period=0.0,total_net_ytd=0.0)
    with pdfplumber.open(io.BytesIO(content)) as pdf:
        txt = " ".join(p.extract_text() or "" for p in pdf.pages)  # On join avec un espace pour Ã©viter les cassures de ligne

    # 1. SOLUTION INFAILLIBLE POUR LA DATE 
    # On cherche dans TOUT le texte (jusqu'Ã  1000 caractÃ¨res)
    search_area = txt[:1000]

    # Recherche 1: "Period DECEMBER - 2025" ou "DECEMBER 2025" ou "DECEMBER 1, 2025"
    m = re.search(r"(JANUARY|FEBRUARY|MARCH|APRIL|MAY|JUNE|JULY|AUGUST|SEPTEMBER|OCTOBER|NOVEMBER|DECEMBER)[^\d](0, 20)(20\d2)", search_area, re.I)
    if m:
        mo, yr = m.group(1).upper(), int(m.group(2))
        r.update(period=f"{mo} {yr}", year=yr, month=mo, month_num=MONTH_MAP.get(mo,0))
    else:
        # Recherche 2 (Date chiffrÃ©e): "12/31/2025"
        m = re.search(r"(\d{1,2})/(\d{1,2})/(20\d2)", search_area)
        if m:
            mo_num, yr = int(m.group(1)), int(m.group(3))
            if 1 <= mo_num <= 12:
                mo = list(MONTH_MAP.keys())[mo_num-1]
                r.update(period=f"{mo} {yr}", year=yr, month=mo, month_num=mo_num)

    if not r["year"]:
        r["debug_text"] = search_area[:150] # Capture le dÃ©but pour debug si Ã§a foire encore
        return r # ArrÃªte le traitement si pas de date

    # Le reste de l'analyse (on repasse en lignes pour les valeurs financiÃ¨res)
    lines = txt.replace("\n", "  ").split("  ") # On recrÃ©e des pseudo-lignes proprement
    # Comme pdfplumber enlÃ¨ve parfois les retours Ã  la ligne, on s'assure de trouver les mots clÃ©s

    # On utilise des regex directes sur tout le texte pour les valeurs clÃ©s
    # Ex: "Short Term Gain 1,087.27 11,394.65 Loss 421.60 3,992.24 Net 665.67 7,402.42"

    m_st_gain = re.search(r"Short Term Gain\s+([\d,\.]+)\s+([\d,\.]+)", txt)
    if m_st_gain: r["st_gain_period"], r["st_gain_ytd"] = pn(m_st_gain.group(1)), pn(m_st_gain.group(2))

    # Pour Loss et Net, on doit Ãªtre proche de Short Term Gain
    m_st_net = re.search(r"Short Term Gain.*?Loss.*?Net\s+(-?[\d,\.]+)\s+(-?[\d,\.]+)", txt)
    if m_st_net: r["st_net_period"], r["st_net_ytd"] = pn(m_st_net.group(1)), pn(m_st_net.group(2))

    m_lt_gain = re.search(r"Long Term Gain\s+(-?[\d,\.]+|-+)\s+(-?[\d,\.]+|-+)", txt)
    if m_lt_gain: 
        r["lt_gain_period"] = pn(m_lt_gain.group(1)) if m_lt_gain.group(1) != "--" else 0.0
        r["lt_gain_ytd"] = pn(m_lt_gain.group(2)) if m_lt_gain.group(2) != "--" else 0.0

    m_lt_net = re.search(r"Long Term Gain.*?Loss.*?Net\s+(-?[\d,\.]+)\s+(-?[\d,\.]+)", txt)
    if m_lt_net: r["lt_net_period"], r["lt_net_ytd"] = pn(m_lt_net.group(1)), pn(m_lt_net.group(2))

    # Dividendes
    m_div = re.search(r"Income Summary.*?Dividend\s+([\d,\.]+)\s+([\d,\.]+)", txt)
    if m_div: r["dividend_period"], r["dividend_ytd"] = pn(m_div.group(1)), pn(m_div.group(2))

    # Total Market Value
    m_tmv = re.search(r"Total Market Value\s+([\d,\.]+)", txt)
    if m_tmv: r["total_market_value"] = pn(m_tmv.group(1))

    # Withholding tax (Retenue Ã  la source)
    # Cherche tous les "Withheld ... FRA w8 ... -0.98"
    wt_matches = re.findall(r"Withheld.*?w8\s+(-[\d,\.]+)", txt)
    r["withholding_tax_period"] = sum(abs(pn(m)) for m in wt_matches)

    r["total_net_period"] = r["st_net_period"] + r["lt_net_period"]
    r["total_net_ytd"]    = r["st_net_ytd"]    + r["lt_net_ytd"]

    return r

@app.get("/")
async def get_index():
    return HTMLResponse(content='<!DOCTYPE html>\n<html lang="fr">\n<head>\n<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">\n<title>ğŸ“Š Alpaca Tax Analyzer</title>\n<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>\n<style>\n:root{--blue:#1565C0;--lblue:#1E88E5;--green:#2E7D32;--red:#C62828;--orange:#E65100;\n  --bg:#0f1117;--card:#1e2130;--card2:#252840;--border:#2d3154;--text:#e8eaf6;\n  --muted:#9fa8da;--accent:#5C6BC0;}\n*{box-sizing:border-box;margin:0;padding:0}\nbody{font-family:\'Segoe UI\',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}\n/* Header */\n.header{background:linear-gradient(135deg,#0d1b4b,#1a237e,#283593);padding:24px 32px;\n  display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 20px #0009}\n.header h1{font-size:1.8rem;font-weight:700;letter-spacing:.5px}\n.header p{color:#90CAF9;font-size:.9rem;margin-top:4px}\n.badge{background:#1565C0;color:#fff;padding:4px 12px;border-radius:20px;font-size:.75rem;font-weight:600}\n/* Layout */\n.app{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 88px)}\n/* Sidebar */\n.sidebar{background:var(--card);padding:20px;border-right:1px solid var(--border);overflow-y:auto}\n.sidebar h3{color:#90CAF9;font-size:.8rem;text-transform:uppercase;letter-spacing:1.5px;\n  margin:16px 0 8px;padding-bottom:4px;border-bottom:1px solid var(--border)}\n.rate-row{display:flex;align-items:center;justify-content:space-between;margin:6px 0}\n.rate-row label{color:var(--muted);font-size:.85rem}\n.rate-row input{width:80px;background:var(--card2);border:1px solid var(--border);\n  color:var(--text);padding:4px 8px;border-radius:6px;text-align:right;font-size:.85rem}\n.rate-row input:focus{outline:none;border-color:var(--accent)}\n.radio-group label{display:flex;align-items:center;gap:8px;padding:8px;\n  border-radius:8px;cursor:pointer;font-size:.9rem;color:var(--muted)}\n.radio-group label:hover{background:var(--card2)}\n.radio-group input[type=radio]:checked + span{color:var(--text);font-weight:600}\n.tmi-row{padding:8px 0}\n.tmi-row label{color:var(--muted);font-size:.85rem;display:block;margin-bottom:4px}\n.tmi-row select{background:var(--card2);border:1px solid var(--border);color:var(--text);\n  padding:6px;border-radius:6px;width:100%}\n/* Main */\n.main{padding:24px;overflow-y:auto}\n/* Upload zone */\n.upload-zone{border:2px dashed var(--border);border-radius:16px;padding:40px;\n  text-align:center;cursor:pointer;transition:.3s;background:var(--card);position:relative}\n.upload-zone:hover,.upload-zone.drag{border-color:var(--accent);background:rgba(92,107,192,.08)}\n.upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}\n.upload-icon{font-size:3rem;margin-bottom:12px}\n.upload-zone h3{font-size:1.1rem;color:#90CAF9}\n.upload-zone p{color:var(--muted);font-size:.85rem;margin-top:6px}\n.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;\n  border-radius:8px;border:none;cursor:pointer;font-size:.9rem;font-weight:600;\n  transition:.2s;text-decoration:none}\n.btn-primary{background:var(--blue);color:#fff}\n.btn-primary:hover{background:var(--lblue)}\n.btn-success{background:var(--green);color:#fff}\n.btn-outline{background:transparent;color:var(--muted);border:1px solid var(--border)}\n.btn-outline:hover{border-color:var(--accent);color:var(--text)}\n/* Status bar */\n.status-bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:16px 0}\n.status-tag{background:var(--card2);border:1px solid var(--border);padding:4px 12px;\n  border-radius:20px;font-size:.8rem;color:var(--muted)}\n.status-tag.ok{border-color:var(--green);color:#81C784}\n.status-tag.err{border-color:var(--red);color:#EF9A9A}\n/* Year selector */\n.year-tabs{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0}\n.year-tab{padding:8px 20px;border-radius:8px;border:1px solid var(--border);\n  background:var(--card2);color:var(--muted);cursor:pointer;font-size:.9rem}\n.year-tab.active,.year-tab:hover{background:var(--blue);border-color:var(--blue);color:#fff}\n/* Tabs */\n.tabs{display:flex;gap:4px;border-bottom:1px solid var(--border);margin:20px 0 0}\n.tab{padding:12px 20px;border-bottom:2px solid transparent;cursor:pointer;\n  font-size:.9rem;color:var(--muted);transition:.2s}\n.tab:hover{color:var(--text)}\n.tab.active{border-bottom-color:var(--accent);color:var(--text);font-weight:600}\n.tab-content{display:none;padding:20px 0}\n.tab-content.active{display:block}\n/* KPI cards */\n.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin:16px 0}\n.kpi{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;\n  border-left:4px solid var(--accent)}\n.kpi .label{color:var(--muted);font-size:.78rem;text-transform:uppercase;letter-spacing:.8px}\n.kpi .value{font-size:1.5rem;font-weight:700;margin-top:6px}\n.kpi .sub{color:var(--muted);font-size:.8rem;margin-top:2px}\n.kpi.green{border-left-color:var(--green)} .kpi.red{border-left-color:var(--red)}\n.kpi.orange{border-left-color:var(--orange)}\n/* Charts */\n.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:16px 0}\n.chart-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px}\n.chart-card.full{grid-column:1/-1}\n.chart-card h4{color:#90CAF9;font-size:.85rem;text-transform:uppercase;\n  letter-spacing:.8px;margin-bottom:16px}\ncanvas{max-height:280px}\n/* Table */\n.data-table{width:100%;border-collapse:collapse;font-size:.85rem;margin-top:12px}\n.data-table th{background:var(--card2);color:var(--muted);text-align:right;\n  padding:10px 12px;font-size:.75rem;text-transform:uppercase;letter-spacing:.8px}\n.data-table th:first-child{text-align:left}\n.data-table td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:right}\n.data-table td:first-child{text-align:left;font-weight:500}\n.data-table tr:hover td{background:rgba(92,107,192,.07)}\n.pos{color:#81C784;font-weight:600} .neg{color:#EF9A9A;font-weight:600}\n/* IFU */\n.ifu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin:16px 0}\n.ifu-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px}\n.ifu-card h4{color:#90CAF9;font-size:.85rem;text-transform:uppercase;\n  letter-spacing:.8px;margin-bottom:14px;display:flex;align-items:center;gap:8px}\n.ifu-row{display:flex;justify-content:space-between;padding:8px 0;\n  border-bottom:1px solid var(--border);font-size:.9rem}\n.ifu-row:last-child{border:none;font-weight:700;font-size:1rem}\n.ifu-row span:last-child{font-weight:600}\n.alert{border-radius:10px;padding:14px 16px;margin:12px 0;font-size:.88rem;\n  display:flex;gap:12px;align-items:flex-start}\n.alert-warn{background:#1a120060;border:1px solid #F9A825;color:#FFE082}\n.alert-info{background:#0a1a3060;border:1px solid #1565C0;color:#90CAF9}\n.formulaire{background:var(--card2);border:1px solid var(--border);\n  border-radius:10px;padding:16px;margin:10px 0}\n.formulaire h5{color:#90CAF9;margin-bottom:10px;font-size:.9rem}\n.form-row{display:flex;justify-content:space-between;font-size:.88rem;\n  padding:6px 0;border-bottom:1px solid var(--border)}\n.form-row:last-child{border:none}\n.form-case{background:var(--card);border:1px solid var(--accent);\n  border-radius:4px;padding:2px 8px;font-family:monospace;font-size:.85rem;color:#CE93D8}\n/* Export */\n.export-bar{display:flex;gap:12px;margin:20px 0;flex-wrap:wrap}\n/* Progress */\n#progress{display:none;text-align:center;padding:30px;color:var(--muted)}\n.spinner{border:3px solid var(--border);border-top-color:var(--accent);\n  border-radius:50%;width:40px;height:40px;animation:spin .8s linear infinite;margin:0 auto 12px}\n@keyframes spin{to{transform:rotate(360deg)}}\n/* Multi-annÃ©es */\n.multi-table{width:100%;border-collapse:collapse;font-size:.9rem}\n.multi-table th{background:var(--card2);color:var(--muted);padding:12px;\n  text-align:center;font-size:.75rem;text-transform:uppercase}\n.multi-table td{padding:12px;text-align:center;border-bottom:1px solid var(--border)}\n.multi-table tr:hover td{background:rgba(92,107,192,.07)}\n/* Responsive */\n@media(max-width:900px){\n  .app{grid-template-columns:1fr}\n  .sidebar{display:none}\n  .chart-row{grid-template-columns:1fr}\n}\n/* Welcome */\n#welcome{text-align:center;padding:60px 20px}\n#welcome .icon{font-size:5rem;margin-bottom:20px}\n#welcome h2{font-size:1.6rem;margin-bottom:10px}\n#welcome p{color:var(--muted);max-width:500px;margin:0 auto 30px}\n.feat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));\n  gap:16px;max-width:800px;margin:30px auto 0;text-align:left}\n.feat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px}\n.feat .icon{font-size:1.8rem;margin-bottom:8px}\n.feat h4{font-size:.95rem;margin-bottom:6px}\n.feat p{font-size:.82rem;color:var(--muted)}\n</style>\n</head>\n<body>\n\n<div class="header">\n  <div>\n    <h1>ğŸ“Š Alpaca Tax Analyzer</h1>\n    <p>Analyseur fiscal & performance â€” RÃ©sidents fiscaux franÃ§ais</p>\n  </div>\n  <div style="display:flex;gap:10px;align-items:center">\n    <span class="badge" id="badge-count">0 relevÃ©(s)</span>\n    <button class="btn btn-outline" onclick="resetApp()">ğŸ”„ RÃ©initialiser</button>\n  </div>\n</div>\n\n<div class="app">\n  <!-- SIDEBAR -->\n  <div class="sidebar">\n    <h3>ğŸ’± Taux EUR/USD</h3>\n    <div id="rates-container"></div>\n\n    <h3>ğŸ›ï¸ RÃ©gime fiscal</h3>\n    <div class="radio-group">\n      <label><input type="radio" name="regime" value="pfu" checked onchange="onRegimeChange()">\n        <span>PFU â€” Flat Tax (30%)</span></label>\n      <label><input type="radio" name="regime" value="barem" onchange="onRegimeChange()">\n        <span>BarÃ¨me progressif</span></label>\n    </div>\n    <div class="tmi-row" id="tmi-row" style="display:none">\n      <label>TMI (%)</label>\n      <select id="tmi-select" onchange="refreshAll()">\n        <option value="11">11%</option><option value="30" selected>30%</option>\n        <option value="41">41%</option><option value="45">45%</option>\n      </select>\n    </div>\n\n    <h3>â„¹ï¸ Ã€ propos</h3>\n    <p style="font-size:.78rem;color:var(--muted);line-height:1.6">\n      Compatible avec les relevÃ©s mensuels Alpaca Securities.<br><br>\n      âš ï¸ Outil indicatif. Consultez un expert-comptable pour votre dÃ©claration officielle.\n    </p>\n  </div>\n\n  <!-- MAIN -->\n  <div class="main">\n    <!-- Upload -->\n    <div class="upload-zone" id="drop-zone" ondragover="onDrag(event)" ondrop="onDrop(event)">\n      <input type="file" id="file-input" accept=".pdf" multiple onchange="handleFiles(this.files)">\n      <div class="upload-icon">ğŸ“</div>\n      <h3>Glissez vos relevÃ©s PDF ici</h3>\n      <p>ou cliquez pour sÃ©lectionner â€” plusieurs fichiers acceptÃ©s, toutes annÃ©es</p>\n    </div>\n    <div id="status-bar" class="status-bar" style="display:none"></div>\n\n    <!-- Progress -->\n    <div id="progress">\n      <div class="spinner"></div>\n      <p id="progress-text">Analyse des PDF en coursâ€¦</p>\n    </div>\n\n    <!-- Year tabs -->\n    <div id="year-tabs" class="year-tabs" style="display:none"></div>\n\n    <!-- Welcome message -->\n    <div id="welcome">\n      <div class="icon">ğŸ“Š</div>\n      <h2>Bienvenue dans Alpaca Tax Analyzer</h2>\n      <p>Chargez vos relevÃ©s PDF Alpaca Securities pour analyser vos performances et prÃ©parer votre dÃ©claration fiscale franÃ§aise.</p>\n      <div class="feat-grid">\n        <div class="feat"><div class="icon">ğŸ“ˆ</div><h4>Performance Mensuelle</h4>\n          <p>Gains/pertes rÃ©alisÃ©s, dividendes et Ã©volution du portefeuille mois par mois.</p></div>\n        <div class="feat"><div class="icon">ğŸ“…</div><h4>Bilan Annuel</h4>\n          <p>SynthÃ¨se complÃ¨te USD et EUR avec graphiques interactifs.</p></div>\n        <div class="feat"><div class="icon">ğŸ§¾</div><h4>IFU & DÃ©claration</h4>\n          <p>Cases 2042-C prÃ©-remplies, formulaires 2047 et 3916, calcul PFU.</p></div>\n        <div class="feat"><div class="icon">ğŸ”„</div><h4>Multi-annÃ©es</h4>\n          <p>Comparaison inter-annuelle et historique fiscal complet.</p></div>\n      </div>\n    </div>\n\n    <!-- Dashboard (hidden until data loaded) -->\n    <div id="dashboard" style="display:none">\n      <div class="tabs">\n        <div class="tab active" onclick="showTab(\'monthly\')">ğŸ“ˆ Mensuel</div>\n        <div class="tab" onclick="showTab(\'annual\')">ğŸ“… Bilan Annuel</div>\n        <div class="tab" onclick="showTab(\'ifu\')">ğŸ§¾ IFU & DÃ©claration</div>\n        <div class="tab" onclick="showTab(\'multi\')">ğŸ”„ Multi-annÃ©es</div>\n      </div>\n\n      <!-- TAB: MENSUEL -->\n      <div class="tab-content active" id="tab-monthly">\n        <div class="kpi-grid" id="kpi-monthly"></div>\n        <div class="chart-row">\n          <div class="chart-card full"><h4>ğŸ“Š Plus/Moins-values rÃ©alisÃ©es par mois</h4>\n            <canvas id="chart-pv"></canvas></div>\n        </div>\n        <div class="chart-row">\n          <div class="chart-card"><h4>ğŸ’° Dividendes mensuels</h4>\n            <canvas id="chart-div"></canvas></div>\n          <div class="chart-card"><h4>ğŸ“ˆ Ã‰volution du portefeuille</h4>\n            <canvas id="chart-port"></canvas></div>\n        </div>\n        <h4 style="margin:20px 0 10px;color:#90CAF9;font-size:.85rem;text-transform:uppercase;letter-spacing:.8px">ğŸ“‹ DÃ©tail mensuel</h4>\n        <div style="overflow-x:auto"><table class="data-table" id="table-monthly"></table></div>\n      </div>\n\n      <!-- TAB: ANNUEL -->\n      <div class="tab-content" id="tab-annual">\n        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">\n          <div><h4 style="color:#90CAF9;margin-bottom:12px">ğŸ‡ºğŸ‡¸ En USD</h4>\n            <div id="annual-usd"></div></div>\n          <div><h4 style="color:#90CAF9;margin-bottom:12px">ğŸ‡«ğŸ‡· En EUR</h4>\n            <div id="annual-eur"></div></div>\n        </div>\n        <div class="chart-card full"><h4>ğŸ“Š SynthÃ¨se annuelle â€” Waterfall</h4>\n          <canvas id="chart-waterfall"></canvas></div>\n      </div>\n\n      <!-- TAB: IFU -->\n      <div class="tab-content" id="tab-ifu">\n        <div class="alert alert-warn">âš ï¸ <div>Ces donnÃ©es sont <strong>indicatives</strong>. Utilisez les taux de change officiels BCE. Consultez un expert-comptable avant soumission.</div></div>\n        <div class="ifu-grid" id="ifu-cards"></div>\n        <h4 style="margin:20px 0 10px;color:#90CAF9;font-size:.85rem;text-transform:uppercase;letter-spacing:.8px">ğŸ“ Formulaires fiscaux</h4>\n        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px" id="formulaires"></div>\n        <div class="export-bar" id="export-bar"></div>\n      </div>\n\n      <!-- TAB: MULTI -->\n      <div class="tab-content" id="tab-multi">\n        <div class="chart-card full" style="margin-bottom:16px">\n          <h4>ğŸ“Š Comparaison annuelle</h4>\n          <canvas id="chart-multi"></canvas>\n        </div>\n        <div style="overflow-x:auto"><table class="multi-table" id="table-multi"></table></div>\n      </div>\n    </div>\n  </div>\n</div>\n\n<script>\n// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst state = { allData: {}, currentYear: null, charts: {} };\n\nconst MONTHS_FR = {1:\'Jan\',2:\'FÃ©v\',3:\'Mar\',4:\'Avr\',5:\'Mai\',6:\'Juin\',\n                   7:\'Juil\',8:\'AoÃ»t\',9:\'Sep\',10:\'Oct\',11:\'Nov\',12:\'DÃ©c\'};\nconst MONTHS_FULL = {1:\'Janvier\',2:\'FÃ©vrier\',3:\'Mars\',4:\'Avril\',5:\'Mai\',6:\'Juin\',\n                     7:\'Juillet\',8:\'AoÃ»t\',9:\'Septembre\',10:\'Octobre\',11:\'Novembre\',12:\'DÃ©cembre\'};\n\nconst DEFAULT_RATES = {2020:1.141,2021:1.183,2022:1.053,2023:1.081,2024:1.085,2025:1.075,2026:1.04};\n\n// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction init() {\n  const rc = document.getElementById(\'rates-container\');\n  for (let y=2020; y<=2026; y++) {\n    rc.innerHTML += `<div class="rate-row">\n      <label>${y}</label>\n      <input type="number" id="rate-${y}" value="${DEFAULT_RATES[y]||1.08}" \n             step="0.001" min="0.5" max="3" onchange="refreshAll()">\n    </div>`;\n  }\n}\n\nfunction getRate(year) {\n  const el = document.getElementById(`rate-${year}`);\n  return el ? parseFloat(el.value)||1.08 : 1.08;\n}\nfunction getRegime() { return document.querySelector(\'[name=regime]:checked\')?.value||\'pfu\'; }\nfunction getTMI() { return parseInt(document.getElementById(\'tmi-select\')?.value||30)/100; }\n\nfunction onRegimeChange() {\n  const barem = getRegime()===\'barem\';\n  document.getElementById(\'tmi-row\').style.display = barem ? \'block\' : \'none\';\n  refreshAll();\n}\n\n// â”€â”€â”€ DRAG & DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction onDrag(e) { e.preventDefault(); document.getElementById(\'drop-zone\').classList.add(\'drag\'); }\nfunction onDrop(e) {\n  e.preventDefault(); document.getElementById(\'drop-zone\').classList.remove(\'drag\');\n  handleFiles(e.dataTransfer.files);\n}\n\n// â”€â”€â”€ UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nasync function handleFiles(files) {\n  if (!files.length) return;\n  document.getElementById(\'welcome\').style.display = \'none\';\n  document.getElementById(\'progress\').style.display = \'block\';\n  document.getElementById(\'dashboard\').style.display = \'none\';\n  document.getElementById(\'year-tabs\').style.display = \'none\';\n\n  const fd = new FormData();\n  for (const f of files) fd.append(\'files\', f);\n\n  try {\n    const res = await fetch(\'/api/upload\', {method:\'POST\', body:fd});\n    const json = await res.json();\n    processStatements(json.statements, json.errors);\n  } catch(e) {\n    document.getElementById(\'progress\').style.display = \'none\';\n    alert(\'Erreur de connexion au serveur : \' + e.message);\n  }\n}\n\nfunction processStatements(stmts, errors) {\n  stmts.forEach(d => {\n    if (!state.allData[d.year]) state.allData[d.year] = {};\n    state.allData[d.year][d.month.toLowerCase()] = d;\n  });\n\n  document.getElementById(\'progress\').style.display = \'none\';\n  document.getElementById(\'badge-count\').textContent = `${stmts.length} relevÃ©(s)`;\n\n  // Status bar\n  const sb = document.getElementById(\'status-bar\');\n  sb.style.display = \'flex\';\n  sb.innerHTML = `<span class="status-tag ok">âœ… ${stmts.length} relevÃ©(s) analysÃ©(s)</span>`;\n  const years = Object.keys(state.allData).sort();\n  if (years.length > 0) {\n      sb.innerHTML += `<span class="status-tag ok">ğŸ“… AnnÃ©es : ${years.join(\', \')}</span>`;\n  }\n  if (errors.length) {\n      // Afficher le message d\'erreur de faÃ§on claire dans l\'UI\n      sb.innerHTML += `<span class="status-tag err" title="${errors[0].msg}">âš ï¸ ${errors.length} erreur(s) - Survoler pour lire</span>`;\n      console.error("Erreur serveur dÃ©taillÃ©e :", errors);\n  }\n\n  if (years.length > 0) {\n      renderYearTabs();\n      const lastYear = parseInt(years[years.length-1]);\n      selectYear(lastYear);\n  } else {\n      document.getElementById(\'welcome\').style.display = \'block\';\n      alert("âŒ " + (errors[0] ? errors[0].msg : "Erreur inconnue, voir la console."));\n  }\n}\n\nfunction renderYearTabs() {\n  const yt = document.getElementById(\'year-tabs\');\n  yt.style.display = \'flex\';\n  yt.innerHTML = Object.keys(state.allData).sort().map(y =>\n    `<div class="year-tab${parseInt(y)===state.currentYear?\' active\':\'\'}" onclick="selectYear(${y})">\n      ğŸ“… ${y} (${Object.keys(state.allData[y]).length} mois)\n    </div>`\n  ).join(\'\');\n}\n\nfunction selectYear(y) {\n  state.currentYear = y;\n  renderYearTabs();\n  document.getElementById(\'dashboard\').style.display = \'block\';\n  refreshAll();\n}\n\nfunction refreshAll() {\n  if (!state.currentYear) return;\n  renderMonthly();\n  renderAnnual();\n  renderIFU();\n  renderMulti();\n}\n\n// â”€â”€â”€ CALCUL ANNUEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction computeAnnual(yearData, eurRate) {\n  const months = Object.values(yearData).sort((a,b)=>a.month_num-b.month_num);\n  const dec = yearData[\'december\'];\n  const pick = (ytd, per) => dec ? (dec[ytd]||0) : months.reduce((s,m)=>s+(m[per]||0),0);\n\n  const d = {\n    st_gain: pick(\'st_gain_ytd\',\'st_gain_period\'),\n    st_loss: pick(\'st_loss_ytd\',\'st_loss_period\'),\n    st_net:  pick(\'st_net_ytd\', \'st_net_period\'),\n    lt_gain: pick(\'lt_gain_ytd\',\'lt_gain_period\'),\n    lt_loss: pick(\'lt_loss_ytd\',\'lt_loss_period\'),\n    lt_net:  pick(\'lt_net_ytd\', \'lt_net_period\'),\n    dividends: pick(\'dividend_ytd\',\'dividend_period\'),\n    withholding: months.reduce((s,m)=>s+(m.withholding_tax_period||0),0),\n  };\n  d.total_net = d.st_net + d.lt_net;\n  Object.keys(d).forEach(k => d[k+\'_eur\'] = d[k]/eurRate);\n\n  const regime = getRegime();\n  const pv_pos = Math.max(0, d.total_net_eur);\n  if (regime===\'pfu\') {\n    d.tax_pv = pv_pos * 0.30;\n    d.tax_div = d.dividends_eur * 0.30;\n    d.regime_label = \'PFU 30%\';\n  } else {\n    const tmi = getTMI(), ps = 0.172;\n    d.tax_pv  = pv_pos * (tmi + ps);\n    d.tax_div = d.dividends_eur * 0.60 * (tmi + ps);\n    d.regime_label = `BarÃ¨me ${(tmi*100).toFixed(0)}%`;\n  }\n  d.tax_total = d.tax_pv + d.tax_div;\n  d.tax_credit = d.withholding_eur;\n  d.tax_net = Math.max(0, d.tax_total - d.tax_credit);\n  d.div_abat = d.dividends_eur * 0.60;\n  return d;\n}\n\n// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst fUSD = v => `$${v.toLocaleString(\'fr-FR\',{minimumFractionDigits:2,maximumFractionDigits:2})}`;\nconst fEUR = v => `${v.toLocaleString(\'fr-FR\',{minimumFractionDigits:2,maximumFractionDigits:2})} â‚¬`;\nconst cls  = v => v>=0?\'pos\':\'neg\';\nconst sign = v => v>=0?\'+\':\'\';\n\nfunction mkChart(id, cfg) {\n  if (state.charts[id]) state.charts[id].destroy();\n  const ctx = document.getElementById(id)?.getContext(\'2d\');\n  if (!ctx) return;\n  Chart.defaults.color=\'#9fa8da\'; Chart.defaults.borderColor=\'#2d3154\';\n  state.charts[id] = new Chart(ctx, cfg);\n}\n\n// â”€â”€â”€ MENSUEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction renderMonthly() {\n  const yd = state.allData[state.currentYear];\n  const months = Object.values(yd).sort((a,b)=>a.month_num-b.month_num);\n  const eur = getRate(state.currentYear);\n  const ann = computeAnnual(yd, eur);\n\n  const labels = months.map(m=>MONTHS_FR[m.month_num]||m.month);\n  const pvCT = months.map(m=>m.st_net_period);\n  const pvLT = months.map(m=>m.lt_net_period);\n  const pvTot = months.map(m=>m.total_net_period);\n  const divs  = months.map(m=>m.dividend_period);\n  const ports  = months.map(m=>m.total_market_value);\n  const lastPort = months[months.length-1]?.total_market_value||0;\n\n  // KPIs\n  document.getElementById(\'kpi-monthly\').innerHTML = `\n    <div class="kpi green"><div class="label">PV Nettes (USD)</div>\n      <div class="value ${cls(ann.total_net)}">${sign(ann.total_net)}${fUSD(ann.total_net)}</div>\n      <div class="sub">Court terme + Long terme</div></div>\n    <div class="kpi ${ann.total_net_eur>=0?\'green\':\'red\'}"><div class="label">PV Nettes (EUR)</div>\n      <div class="value ${cls(ann.total_net_eur)}">${sign(ann.total_net_eur)}${fEUR(ann.total_net_eur)}</div>\n      <div class="sub">Taux ${eur.toFixed(3)}</div></div>\n    <div class="kpi orange"><div class="label">Dividendes (USD)</div>\n      <div class="value">${fUSD(ann.dividends)}</div>\n      <div class="sub">Bruts avant retenue</div></div>\n    <div class="kpi"><div class="label">Portfolio final</div>\n      <div class="value">${fUSD(lastPort)}</div>\n      <div class="sub">${months.length} mois chargÃ©s</div></div>\n    <div class="kpi red"><div class="label">ImpÃ´t estimÃ© (${ann.regime_label})</div>\n      <div class="value">${fEUR(ann.tax_net)}</div>\n      <div class="sub">AprÃ¨s crÃ©dit impÃ´t Ã©tranger</div></div>`;\n\n  // Chart PV\n  mkChart(\'chart-pv\',{type:\'bar\',data:{labels,datasets:[\n    {label:\'PV Court terme\',data:pvCT,backgroundColor:pvCT.map(v=>v>=0?\'#43A047aa\':\'#E53935aa\'),borderWidth:1},\n    {label:\'PV Long terme\',data:pvLT,backgroundColor:pvLT.map(v=>v>=0?\'#1E88E5aa\':\'#FB8C00aa\'),borderWidth:1},\n    {label:\'Total net\',data:pvTot,type:\'line\',borderColor:\'#CE93D8\',borderWidth:2.5,\n     pointBackgroundColor:\'#CE93D8\',tension:.3,fill:false,yAxisID:\'y\'}\n  ]},options:{responsive:true,interaction:{mode:\'index\'},plugins:{legend:{position:\'top\'}},\n    scales:{y:{grid:{color:\'#2d3154\'}}}}});\n\n  // Chart Dividendes\n  mkChart(\'chart-div\',{type:\'bar\',data:{labels,datasets:[\n    {label:\'Dividendes ($)\',data:divs,backgroundColor:\'#FFA726bb\',borderWidth:1}\n  ]},options:{responsive:true,plugins:{legend:{display:false}},\n    scales:{y:{grid:{color:\'#2d3154\'}}}}});\n\n  // Chart Portfolio\n  if (ports.some(v=>v>0))\n    mkChart(\'chart-port\',{type:\'line\',data:{labels,datasets:[\n      {label:\'Portfolio ($)\',data:ports,borderColor:\'#1565C0\',borderWidth:2.5,\n       backgroundColor:\'rgba(21,101,192,.1)\',fill:true,tension:.3,pointRadius:4}\n    ]},options:{responsive:true,plugins:{legend:{display:false}},\n      scales:{y:{grid:{color:\'#2d3154\'}}}}});\n\n  // Table\n  const tbl = document.getElementById(\'table-monthly\');\n  tbl.innerHTML = `<tr><th>Mois</th><th>PV CT ($)</th><th>PV LT ($)</th>\n    <th>PV Total ($)</th><th>PV Total (â‚¬)</th><th>Dividendes ($)</th><th>Portfolio ($)</th></tr>` +\n    months.map(m=>{\n      const tot=m.total_net_period, totE=tot/eur;\n      return `<tr>\n        <td>${MONTHS_FULL[m.month_num]||m.month}</td>\n        <td class="${cls(m.st_net_period)}">${sign(m.st_net_period)}${fUSD(m.st_net_period)}</td>\n        <td class="${cls(m.lt_net_period)}">${sign(m.lt_net_period)}${fUSD(m.lt_net_period)}</td>\n        <td class="${cls(tot)}">${sign(tot)}${fUSD(tot)}</td>\n        <td class="${cls(totE)}">${sign(totE)}${fEUR(totE)}</td>\n        <td>${fUSD(m.dividend_period)}</td>\n        <td>${m.total_market_value>0?fUSD(m.total_market_value):\'â€”\'}</td>\n      </tr>`;}).join(\'\');\n}\n\n// â”€â”€â”€ ANNUEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction renderAnnual() {\n  const yd = state.allData[state.currentYear];\n  const eur = getRate(state.currentYear);\n  const a = computeAnnual(yd, eur);\n  const src = yd[\'december\'] ? \'(YTD dÃ©cembre)\' : \'(cumul mensuel)\';\n\n  const mkTable = rows => `<table class="data-table">${rows.map(([l,v,e])=>\n    `<tr><td>${l}</td><td class="${cls(v)}">${sign(v)}${fUSD(v)}</td>\n         <td class="${cls(e)}">${sign(e)}${fEUR(e)}</td></tr>`).join(\'\')}</table>`;\n\n  document.getElementById(\'annual-usd\').innerHTML =\n    `<p style="color:var(--muted);font-size:.8rem;margin-bottom:8px">Source: ${src}</p>` +\n    mkTable([\n      [\'Gains CT\',  a.st_gain,  a.st_gain_eur],\n      [\'Pertes CT\', -a.st_loss, -a.st_loss_eur],\n      [\'Net CT\',    a.st_net,   a.st_net_eur],\n      [\'Gains LT\',  a.lt_gain,  a.lt_gain_eur],\n      [\'Pertes LT\', -a.lt_loss, -a.lt_loss_eur],\n      [\'Net LT\',    a.lt_net,   a.lt_net_eur],\n      [\'â® TOTAL\',  a.total_net, a.total_net_eur],\n      [\'Dividendes\', a.dividends, a.dividends_eur],\n      [\'Retenue src.\', -a.withholding, -a.withholding_eur],\n    ]);\n  document.getElementById(\'annual-eur\').innerHTML = document.getElementById(\'annual-usd\').innerHTML;\n\n  // Waterfall simulation via bar chart\n  const wfLabels = [\'Gains CT\',\'Pertes CT\',\'Net CT\',\'Gains LT\',\'Pertes LT\',\'Net LT\',\'Dividendes\'];\n  const wfVals = [a.st_gain_eur,-a.st_loss_eur,a.st_net_eur,a.lt_gain_eur,-a.lt_loss_eur,a.lt_net_eur,a.dividends_eur];\n  mkChart(\'chart-waterfall\',{type:\'bar\',data:{labels:wfLabels,datasets:[{\n    label:\'EUR (â‚¬)\',data:wfVals,\n    backgroundColor:wfVals.map(v=>v>=0?\'#43A047cc\':\'#E53935cc\'),borderWidth:1\n  }]},options:{responsive:true,plugins:{legend:{display:false},\n    tooltip:{callbacks:{label:ctx=>`${fEUR(ctx.raw)}`}}},\n    scales:{y:{grid:{color:\'#2d3154\'},ticks:{callback:v=>`${v.toLocaleString(\'fr-FR\')} â‚¬`}}}}});\n}\n\n// â”€â”€â”€ IFU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction renderIFU() {\n  const yd = state.allData[state.currentYear];\n  const eur = getRate(state.currentYear);\n  const a = computeAnnual(yd, eur);\n  const y = state.currentYear;\n\n  document.getElementById(\'ifu-cards\').innerHTML = `\n    <div class="ifu-card">\n      <h4>ğŸ“ˆ Plus-values mobiliÃ¨res</h4>\n      <div class="ifu-row"><span>PV CT nettes</span><span class="${cls(a.st_net_eur)}">${sign(a.st_net_eur)}${fEUR(a.st_net_eur)}</span></div>\n      <div class="ifu-row"><span>PV LT nettes</span><span class="${cls(a.lt_net_eur)}">${sign(a.lt_net_eur)}${fEUR(a.lt_net_eur)}</span></div>\n      <div class="ifu-row"><span>Total PV nettes</span><span class="${cls(a.total_net_eur)}">${sign(a.total_net_eur)}${fEUR(a.total_net_eur)}</span></div>\n    </div>\n    <div class="ifu-card">\n      <h4>ğŸ’° Revenus mobiliers</h4>\n      <div class="ifu-row"><span>Dividendes bruts</span><span>${fEUR(a.dividends_eur)}</span></div>\n      <div class="ifu-row"><span>Retenue source (15% US)</span><span class="neg">-${fEUR(a.withholding_eur)}</span></div>\n      <div class="ifu-row"><span>Dividendes nets</span><span>${fEUR(a.dividends_eur-a.withholding_eur)}</span></div>\n    </div>\n    <div class="ifu-card">\n      <h4>ğŸ›ï¸ ImpÃ´t estimÃ© (${a.regime_label})</h4>\n      <div class="ifu-row"><span>ImpÃ´t sur PV</span><span>${fEUR(a.tax_pv)}</span></div>\n      <div class="ifu-row"><span>ImpÃ´t sur dividendes</span><span>${fEUR(a.tax_div)}</span></div>\n      <div class="ifu-row"><span>Total avant crÃ©dit</span><span>${fEUR(a.tax_total)}</span></div>\n      <div class="ifu-row"><span>CrÃ©dit impÃ´t Ã©tranger</span><span class="neg">-${fEUR(a.tax_credit)}</span></div>\n      <div class="ifu-row"><span>ğŸ”´ NET Ã€ PAYER</span><span class="neg">${fEUR(a.tax_net)}</span></div>\n    </div>`;\n\n  const pv3VG = Math.max(0, a.total_net_eur);\n  const pv3VH = Math.max(0, -a.total_net_eur);\n\n  document.getElementById(\'formulaires\').innerHTML = `\n    <div class="formulaire">\n      <h5>ğŸ“„ Formulaire 2042-C</h5>\n      <div class="form-row"><span>Case <span class="form-case">3VG</span> PV imposables</span><span>${fEUR(pv3VG)}</span></div>\n      <div class="form-row"><span>Case <span class="form-case">3VH</span> MV imputables</span><span>${fEUR(pv3VH)}</span></div>\n      <div class="form-row"><span>Case <span class="form-case">2DC</span> Dividendes PFU</span><span>${fEUR(a.dividends_eur)}</span></div>\n      <div class="form-row"><span>Case <span class="form-case">2AB</span> CrÃ©dit impÃ´t</span><span>${fEUR(a.withholding_eur)}</span></div>\n      ${getRegime()===\'barem\'?`<div class="form-row"><span>Case <span class="form-case">2BH</span> Div. barÃ¨me</span><span>${fEUR(a.dividends_eur)}</span></div>\n      <div class="form-row"><span>Case <span class="form-case">2DA</span> Div. (abat. 40%)</span><span>${fEUR(a.div_abat)}</span></div>`:\'\'}\n    </div>\n    <div class="formulaire">\n      <h5>ğŸ“„ Formulaire 2047 â€” Revenus Ã©trangers</h5>\n      <div class="form-row"><span>Section IV â€“ Dividendes Ã©trangers</span><span>${fEUR(a.dividends_eur)}</span></div>\n      <div class="form-row"><span>CrÃ©dit impÃ´t (retenue 15%)</span><span>${fEUR(a.withholding_eur)}</span></div>\n      <div class="form-row"><span>Section V â€“ PV Ã©trangÃ¨res</span><span class="${cls(a.total_net_eur)}">${fEUR(a.total_net_eur)}</span></div>\n    </div>\n    <div class="formulaire">\n      <h5>ğŸ“„ Formulaire 3916 â€” Compte Ã©tranger âš ï¸</h5>\n      <div class="form-row"><span>Ã‰tablissement</span><span>Alpaca Securities LLC</span></div>\n      <div class="form-row"><span>Pays</span><span>ğŸ‡ºğŸ‡¸ Ã‰tats-Unis</span></div>\n      <div class="form-row"><span>Type</span><span>Compte-titres</span></div>\n      <div class="form-row"><span>Adresse</span><span>Nicosia, CYP 2113</span></div>\n      <div class="form-row"><span>Obligation</span><span style="color:#EF9A9A">Annuelle obligatoire</span></div>\n    </div>`;\n\n  const months = Object.values(yd).sort((a,b)=>a.month_num-b.month_num);\n  const csvRows = [\'Mois;PV_CT_USD;PV_LT_USD;PV_Total_USD;PV_CT_EUR;PV_LT_EUR;PV_Total_EUR;Dividendes_USD;Dividendes_EUR;RetenueSrc_USD;Portfolio_USD\',\n    ...months.map(m=>[\n      MONTHS_FULL[m.month_num]||m.month, m.st_net_period, m.lt_net_period, m.total_net_period,\n      (m.st_net_period/eur).toFixed(2), (m.lt_net_period/eur).toFixed(2), (m.total_net_period/eur).toFixed(2),\n      m.dividend_period, (m.dividend_period/eur).toFixed(2), m.withholding_tax_period, m.total_market_value\n    ].join(\';\'))].join(\'\\n\');\n\n  const ifuTxt = `RÃ‰CAPITULATIF FISCAL ${y} â€” ALPACA SECURITIES\n${\'=\'.repeat(55)}\nTaux EUR/USD : ${eur.toFixed(3)} | RÃ©gime : ${a.regime_label}\nGÃ©nÃ©rÃ© le : ${new Date().toLocaleString(\'fr-FR\')}\n\nPLUS-VALUES MOBILIÃˆRES\n${\'â”€\'.repeat(40)}\nGains CT rÃ©alisÃ©s  : ${fUSD(a.st_gain).padStart(15)} / ${fEUR(a.st_gain_eur).padStart(14)}\nPertes CT rÃ©alisÃ©es: ${fUSD(a.st_loss).padStart(15)} / ${fEUR(a.st_loss_eur).padStart(14)}\nNet CT             : ${fUSD(a.st_net).padStart(15)} / ${fEUR(a.st_net_eur).padStart(14)}\nGains LT rÃ©alisÃ©s  : ${fUSD(a.lt_gain).padStart(15)} / ${fEUR(a.lt_gain_eur).padStart(14)}\nPertes LT rÃ©alisÃ©es: ${fUSD(a.lt_loss).padStart(15)} / ${fEUR(a.lt_loss_eur).padStart(14)}\nNet LT             : ${fUSD(a.lt_net).padStart(15)} / ${fEUR(a.lt_net_eur).padStart(14)}\nTOTAL PV NETTES    : ${fUSD(a.total_net).padStart(15)} / ${fEUR(a.total_net_eur).padStart(14)}\n\nREVENUS DE CAPITAUX MOBILIERS\n${\'â”€\'.repeat(40)}\nDividendes bruts   : ${fUSD(a.dividends).padStart(15)} / ${fEUR(a.dividends_eur).padStart(14)}\nRetenue source 15% : ${fUSD(a.withholding).padStart(15)} / ${fEUR(a.withholding_eur).padStart(14)}\n\nFISCALITÃ‰ ESTIMÃ‰E (${a.regime_label})\n${\'â”€\'.repeat(40)}\nImpÃ´t PV           :                    ${fEUR(a.tax_pv).padStart(14)}\nImpÃ´t dividendes   :                    ${fEUR(a.tax_div).padStart(14)}\nTotal              :                    ${fEUR(a.tax_total).padStart(14)}\nCrÃ©dit impÃ´t       :                   -${fEUR(a.tax_credit).padStart(14)}\nNET Ã€ PAYER        :                    ${fEUR(a.tax_net).padStart(14)}\n\nCASES 2042-C\n3VG (PV imposables)  : ${fEUR(pv3VG)}\n3VH (MV imputables)  : ${fEUR(pv3VH)}\n2DC (Dividendes PFU) : ${fEUR(a.dividends_eur)}\n2AB (CrÃ©dit impÃ´t)   : ${fEUR(a.withholding_eur)}\n\nâš ï¸ Document indicatif â€” Consultez un expert-comptable.`;\n\n  document.getElementById(\'export-bar\').innerHTML = `\n    <button class="btn btn-success" onclick="downloadTxt(\'IFU_${y}_Alpaca.txt\',${JSON.stringify(ifuTxt)})">ğŸ“¥ TÃ©lÃ©charger IFU (.txt)</button>\n    <button class="btn btn-outline" onclick="downloadCsv(\'Alpaca_${y}_data.csv\',${JSON.stringify(csvRows)})">ğŸ“Š TÃ©lÃ©charger donnÃ©es (.csv)</button>`;\n}\n\n// â”€â”€â”€ MULTI-ANNÃ‰ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction renderMulti() {\n  const years = Object.keys(state.allData).map(Number).sort();\n  if (years.length < 1) return;\n\n  const rows = years.map(y=>({\n    y, a: computeAnnual(state.allData[y], getRate(y))\n  }));\n\n  const labels = rows.map(r=>String(r.y));\n  mkChart(\'chart-multi\',{type:\'bar\',data:{labels,datasets:[\n    {label:\'PV nettes (â‚¬)\',data:rows.map(r=>r.a.total_net_eur),backgroundColor:\'#1E88E5bb\'},\n    {label:\'Dividendes (â‚¬)\',data:rows.map(r=>r.a.dividends_eur),backgroundColor:\'#FFA726bb\'},\n    {label:\'ImpÃ´t net (â‚¬)\',data:rows.map(r=>r.a.tax_net),backgroundColor:\'#E53935bb\'},\n  ]},options:{responsive:true,interaction:{mode:\'index\'},plugins:{legend:{position:\'top\'}},\n    scales:{y:{grid:{color:\'#2d3154\'}}}}});\n\n  document.getElementById(\'table-multi\').innerHTML =\n    `<tr><th>AnnÃ©e</th><th>PV nettes ($)</th><th>PV nettes (â‚¬)</th>\n     <th>Dividendes (â‚¬)</th><th>Retenue src (â‚¬)</th><th>ImpÃ´t PFU (â‚¬)</th><th>Net Ã  payer (â‚¬)</th></tr>` +\n    rows.map(({y,a})=>`<tr>\n      <td><strong>${y}</strong></td>\n      <td class="${cls(a.total_net)}">${sign(a.total_net)}${fUSD(a.total_net)}</td>\n      <td class="${cls(a.total_net_eur)}">${sign(a.total_net_eur)}${fEUR(a.total_net_eur)}</td>\n      <td>${fEUR(a.dividends_eur)}</td>\n      <td class="neg">-${fEUR(a.withholding_eur)}</td>\n      <td>${fEUR(a.tax_total)}</td>\n      <td class="neg"><strong>${fEUR(a.tax_net)}</strong></td>\n    </tr>`).join(\'\');\n}\n\n// â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction showTab(name) {\n  document.querySelectorAll(\'.tab\').forEach(t=>t.classList.remove(\'active\'));\n  document.querySelectorAll(\'.tab-content\').forEach(t=>t.classList.remove(\'active\'));\n  event.target.classList.add(\'active\');\n  document.getElementById(\'tab-\'+name).classList.add(\'active\');\n}\n\n// â”€â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction downloadTxt(name, content) {\n  const a = document.createElement(\'a\');\n  a.href = URL.createObjectURL(new Blob([content],{type:\'text/plain\'}));\n  a.download = name; a.click();\n}\nfunction downloadCsv(name, content) {\n  const a = document.createElement(\'a\');\n  a.href = URL.createObjectURL(new Blob([content],{type:\'text/csv\'}));\n  a.download = name; a.click();\n}\n\nfunction resetApp() {\n  if (!confirm(\'RÃ©initialiser toutes les donnÃ©es ?\')) return;\n  state.allData = {}; state.currentYear = null;\n  Object.values(state.charts).forEach(c=>c.destroy());\n  state.charts = {};\n  document.getElementById(\'welcome\').style.display = \'block\';\n  document.getElementById(\'dashboard\').style.display = \'none\';\n  document.getElementById(\'year-tabs\').style.display = \'none\';\n  document.getElementById(\'status-bar\').style.display = \'none\';\n  document.getElementById(\'badge-count\').textContent = \'0 relevÃ©(s)\';\n  document.getElementById(\'file-input\').value = \'\';\n}\n\n// â”€â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\ninit();\n</script>\n</body>\n</html>')

@app.post("/api/upload")
async def upload(files: List[UploadFile] = File(...)):
    ok, err = [], []
    for f in files:
        try:
            d = parse_pdf(await f.read())
            if d.get("year") and d.get("month_num"): 
                ok.append(d)
            else: 
                err.append({"file": f.filename, "msg": f"Date introuvable. EntÃªte lue: {d.get('debug_text','')}..."})
        except Exception as e:
            err.append({"file": f.filename, "msg": str(e)})
    return {"statements": ok, "errors": err}
