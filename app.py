HTML_CONTENT = '<!DOCTYPE html>\n<html lang="fr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Alpaca Tax Analyzer</title>\n<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>\n<style>\n:root{--blue:#1565C0;--lblue:#1E88E5;--green:#2E7D32;--red:#C62828;--orange:#E65100;--bg:#0f1117;--card:#1e2130;--card2:#252840;--border:#2d3154;--text:#e8eaf6;--muted:#9fa8da;--accent:#5C6BC0;}\n*{box-sizing:border-box;margin:0;padding:0}body{font-family:\'Segoe UI\',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}\n.header{background:linear-gradient(135deg,#0d1b4b,#1a237e,#283593);padding:24px 32px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 20px #0009}.header h1{font-size:1.8rem;font-weight:700}.header p{color:#90CAF9;font-size:.9rem;margin-top:4px}.badge{background:#1565C0;color:#fff;padding:4px 12px;border-radius:20px;font-size:.75rem;font-weight:600}\n.app{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 88px)}\n.sidebar{background:var(--card);padding:20px;border-right:1px solid var(--border);overflow-y:auto}.sidebar h3{color:#90CAF9;font-size:.8rem;text-transform:uppercase;letter-spacing:1.5px;margin:16px 0 8px;padding-bottom:4px;border-bottom:1px solid var(--border)}\n.rate-row{display:flex;align-items:center;justify-content:space-between;margin:6px 0}.rate-row label{color:var(--muted);font-size:.85rem}.rate-row input{width:80px;background:var(--card2);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:6px;text-align:right;font-size:.85rem}\n.radio-group label{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;cursor:pointer;font-size:.9rem;color:var(--muted)}.radio-group label:hover{background:var(--card2)}.radio-group input[type=radio]:checked + span{color:var(--text);font-weight:600}\n.tmi-row{padding:8px 0}.tmi-row label{color:var(--muted);font-size:.85rem;display:block;margin-bottom:4px}.tmi-row select{background:var(--card2);border:1px solid var(--border);color:var(--text);padding:6px;border-radius:6px;width:100%}\n.main{padding:24px;overflow-y:auto}\n.upload-zone{border:2px dashed var(--border);border-radius:16px;padding:40px;text-align:center;cursor:pointer;transition:.3s;background:var(--card);position:relative}.upload-zone:hover,.upload-zone.drag{border-color:var(--accent);background:rgba(92,107,192,.08)}.upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}.upload-icon{font-size:3rem;margin-bottom:12px}.upload-zone h3{font-size:1.1rem;color:#90CAF9}.upload-zone p{color:var(--muted);font-size:.85rem;margin-top:6px}\n.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border-radius:8px;border:none;cursor:pointer;font-size:.9rem;font-weight:600;transition:.2s}.btn-success{background:var(--green);color:#fff}.btn-outline{background:transparent;color:var(--muted);border:1px solid var(--border)}.btn-outline:hover{border-color:var(--accent);color:var(--text)}\n.status-bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:16px 0}.status-tag{background:var(--card2);border:1px solid var(--border);padding:4px 12px;border-radius:20px;font-size:.8rem;color:var(--muted)}.status-tag.ok{border-color:var(--green);color:#81C784}.status-tag.err{border-color:var(--red);color:#EF9A9A}\n.year-tabs{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0}.year-tab{padding:8px 20px;border-radius:8px;border:1px solid var(--border);background:var(--card2);color:var(--muted);cursor:pointer;font-size:.9rem}.year-tab.active,.year-tab:hover{background:var(--blue);border-color:var(--blue);color:#fff}\n.tabs{display:flex;gap:4px;border-bottom:1px solid var(--border);margin:20px 0 0}.tab{padding:12px 20px;border-bottom:2px solid transparent;cursor:pointer;font-size:.9rem;color:var(--muted);transition:.2s}.tab:hover{color:var(--text)}.tab.active{border-bottom-color:var(--accent);color:var(--text);font-weight:600}.tab-content{display:none;padding:20px 0}.tab-content.active{display:block}\n.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin:16px 0}.kpi{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;border-left:4px solid var(--accent)}.kpi .label{color:var(--muted);font-size:.78rem;text-transform:uppercase;letter-spacing:.8px}.kpi .value{font-size:1.5rem;font-weight:700;margin-top:6px}.kpi .sub{color:var(--muted);font-size:.8rem;margin-top:2px}.kpi.green{border-left-color:var(--green)}.kpi.red{border-left-color:var(--red)}.kpi.orange{border-left-color:var(--orange)}\n.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:16px 0}.chart-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px}.chart-card.full{grid-column:1/-1}.chart-card h4{color:#90CAF9;font-size:.85rem;text-transform:uppercase;letter-spacing:.8px;margin-bottom:16px}canvas{max-height:280px}\n.data-table{width:100%;border-collapse:collapse;font-size:.85rem;margin-top:12px}.data-table th{background:var(--card2);color:var(--muted);text-align:right;padding:10px 12px;font-size:.75rem;text-transform:uppercase;letter-spacing:.8px}.data-table th:first-child{text-align:left}.data-table td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:right}.data-table td:first-child{text-align:left;font-weight:500}.data-table tr:hover td{background:rgba(92,107,192,.07)}.pos{color:#81C784;font-weight:600}.neg{color:#EF9A9A;font-weight:600}\n.ifu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin:16px 0}.ifu-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px}.ifu-card h4{color:#90CAF9;font-size:.85rem;text-transform:uppercase;letter-spacing:.8px;margin-bottom:14px}.ifu-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:.9rem}.ifu-row:last-child{border:none;font-weight:700}.ifu-row span:last-child{font-weight:600}\n.alert{border-radius:10px;padding:14px 16px;margin:12px 0;font-size:.88rem;display:flex;gap:12px;align-items:flex-start}.alert-warn{background:#1a120060;border:1px solid #F9A825;color:#FFE082}\n.formulaire{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:16px;margin:10px 0}.formulaire h5{color:#90CAF9;margin-bottom:10px;font-size:.9rem}.form-row{display:flex;justify-content:space-between;font-size:.88rem;padding:6px 0;border-bottom:1px solid var(--border)}.form-row:last-child{border:none}.form-case{background:var(--card);border:1px solid var(--accent);border-radius:4px;padding:2px 8px;font-family:monospace;font-size:.85rem;color:#CE93D8}\n.export-bar{display:flex;gap:12px;margin:20px 0;flex-wrap:wrap}\n.debug-box{background:#0a0f1e;border:1px solid #F9A825;border-radius:10px;padding:16px;margin:16px 0;font-family:monospace;font-size:.75rem;white-space:pre-wrap;color:#FFE082;max-height:300px;overflow-y:auto;display:none}\n#progress{display:none;text-align:center;padding:30px;color:var(--muted)}.spinner{border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;width:40px;height:40px;animation:spin .8s linear infinite;margin:0 auto 12px}@keyframes spin{to{transform:rotate(360deg)}}\n.multi-table{width:100%;border-collapse:collapse;font-size:.9rem}.multi-table th{background:var(--card2);color:var(--muted);padding:12px;text-align:center;font-size:.75rem;text-transform:uppercase}.multi-table td{padding:12px;text-align:center;border-bottom:1px solid var(--border)}\n@media(max-width:900px){.app{grid-template-columns:1fr}.sidebar{display:none}.chart-row{grid-template-columns:1fr}}\n#welcome{text-align:center;padding:60px 20px}#welcome .icon{font-size:5rem;margin-bottom:20px}#welcome h2{font-size:1.6rem;margin-bottom:10px}#welcome p{color:var(--muted);max-width:500px;margin:0 auto 30px}\n.feat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;max-width:800px;margin:30px auto 0;text-align:left}.feat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px}.feat .icon{font-size:1.8rem;margin-bottom:8px}.feat h4{font-size:.95rem;margin-bottom:6px}.feat p{font-size:.82rem;color:var(--muted)}\n</style></head><body>\n<div class="header">\n  <div><h1>üìä Alpaca Tax Analyzer</h1><p>Analyseur fiscal & performance ‚Äî R√©sidents fiscaux fran√ßais</p></div>\n  <div style="display:flex;gap:10px;align-items:center"><span class="badge" id="badge-count">0 relev√©(s)</span><button class="btn btn-outline" onclick="resetApp()">üîÑ R√©initialiser</button></div>\n</div>\n<div class="app">\n  <div class="sidebar">\n    <h3>üí± Taux EUR/USD</h3><div id="rates-container"></div>\n    <h3>üèõÔ∏è R√©gime fiscal</h3>\n    <div class="radio-group">\n      <label><input type="radio" name="regime" value="pfu" checked onchange="onRegimeChange()"><span>PFU ‚Äî Flat Tax (30%)</span></label>\n      <label><input type="radio" name="regime" value="barem" onchange="onRegimeChange()"><span>Bar√®me progressif</span></label>\n    </div>\n    <div class="tmi-row" id="tmi-row" style="display:none"><label>TMI (%)</label><select id="tmi-select" onchange="refreshAll()"><option value="11">11%</option><option value="30" selected>30%</option><option value="41">41%</option><option value="45">45%</option></select></div>\n    <h3>‚ÑπÔ∏è √Ä propos</h3>\n    <p style="font-size:.78rem;color:var(--muted);line-height:1.6">Compatible avec les relev√©s mensuels Alpaca Securities.<br><br>‚ö†Ô∏è Outil indicatif. Consultez un expert-comptable.</p>\n  </div>\n  <div class="main">\n    <div class="upload-zone" id="drop-zone" ondragover="onDrag(event)" ondrop="onDrop(event)">\n      <input type="file" id="file-input" accept=".pdf" multiple onchange="handleFiles(this.files)">\n      <div class="upload-icon">üìÅ</div><h3>Glissez vos relev√©s PDF ici</h3>\n      <p>ou cliquez pour s√©lectionner ‚Äî plusieurs fichiers accept√©s, toutes ann√©es</p>\n    </div>\n    <div id="status-bar" class="status-bar" style="display:none"></div>\n    <div id="debug-box" class="debug-box"></div>\n    <div id="progress"><div class="spinner"></div><p>Analyse en cours‚Ä¶</p></div>\n    <div id="year-tabs" class="year-tabs" style="display:none"></div>\n    <div id="welcome">\n      <div class="icon">üìä</div><h2>Bienvenue dans Alpaca Tax Analyzer</h2>\n      <p>Chargez vos relev√©s PDF Alpaca Securities pour analyser vos performances et pr√©parer votre d√©claration fiscale fran√ßaise.</p>\n      <div class="feat-grid">\n        <div class="feat"><div class="icon">üìà</div><h4>Performance Mensuelle</h4><p>Gains/pertes r√©alis√©s, dividendes et √©volution du portefeuille.</p></div>\n        <div class="feat"><div class="icon">üìÖ</div><h4>Bilan Annuel</h4><p>Synth√®se compl√®te USD et EUR avec graphiques interactifs.</p></div>\n        <div class="feat"><div class="icon">üßæ</div><h4>IFU & D√©claration</h4><p>Cases 2042-C pr√©-remplies, formulaires 2047 et 3916.</p></div>\n        <div class="feat"><div class="icon">üîÑ</div><h4>Multi-ann√©es</h4><p>Comparaison inter-annuelle et historique fiscal complet.</p></div>\n      </div>\n    </div>\n    <div id="dashboard" style="display:none">\n      <div class="tabs">\n        <div class="tab active" onclick="showTab(\'monthly\',event)">üìà Mensuel</div>\n        <div class="tab" onclick="showTab(\'annual\',event)">üìÖ Bilan Annuel</div>\n        <div class="tab" onclick="showTab(\'ifu\',event)">üßæ IFU & D√©claration</div>\n        <div class="tab" onclick="showTab(\'multi\',event)">üîÑ Multi-ann√©es</div>\n      </div>\n      <div class="tab-content active" id="tab-monthly">\n        <div class="kpi-grid" id="kpi-monthly"></div>\n        <div class="chart-row"><div class="chart-card full"><h4>üìä Plus/Moins-values r√©alis√©es</h4><canvas id="chart-pv"></canvas></div></div>\n        <div class="chart-row"><div class="chart-card"><h4>üí∞ Dividendes mensuels</h4><canvas id="chart-div"></canvas></div><div class="chart-card"><h4>üìà √âvolution du portefeuille</h4><canvas id="chart-port"></canvas></div></div>\n        <h4 style="margin:20px 0 10px;color:#90CAF9;font-size:.85rem;text-transform:uppercase;letter-spacing:.8px">üìã D√©tail mensuel</h4>\n        <div style="overflow-x:auto"><table class="data-table" id="table-monthly"></table></div>\n      </div>\n      <div class="tab-content" id="tab-annual">\n        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">\n          <div><h4 style="color:#90CAF9;margin-bottom:12px">üá∫üá∏ En USD</h4><div id="annual-usd"></div></div>\n          <div><h4 style="color:#90CAF9;margin-bottom:12px">üá´üá∑ En EUR</h4><div id="annual-eur"></div></div>\n        </div>\n        <div class="chart-card full"><h4>üìä Synth√®se annuelle</h4><canvas id="chart-waterfall"></canvas></div>\n      </div>\n      <div class="tab-content" id="tab-ifu">\n        <div class="alert alert-warn">‚ö†Ô∏è <div>Ces donn√©es sont <strong>indicatives</strong>. Consultez un expert-comptable avant soumission.</div></div>\n        <div class="ifu-grid" id="ifu-cards"></div>\n        <h4 style="margin:20px 0 10px;color:#90CAF9;font-size:.85rem;text-transform:uppercase;letter-spacing:.8px">üìù Formulaires fiscaux</h4>\n        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px" id="formulaires"></div>\n        <div class="export-bar" id="export-bar"></div>\n      </div>\n      <div class="tab-content" id="tab-multi">\n        <div class="chart-card full" style="margin-bottom:16px"><h4>üìä Comparaison annuelle</h4><canvas id="chart-multi"></canvas></div>\n        <div style="overflow-x:auto"><table class="multi-table" id="table-multi"></table></div>\n      </div>\n    </div>\n  </div>\n</div>\n<script>\nconst state={allData:{},currentYear:null,charts:{}};\nconst MFR={1:\'Jan\',2:\'F√©v\',3:\'Mar\',4:\'Avr\',5:\'Mai\',6:\'Juin\',7:\'Juil\',8:\'Ao√ªt\',9:\'Sep\',10:\'Oct\',11:\'Nov\',12:\'D√©c\'};\nconst MFULL={1:\'Janvier\',2:\'F√©vrier\',3:\'Mars\',4:\'Avril\',5:\'Mai\',6:\'Juin\',7:\'Juillet\',8:\'Ao√ªt\',9:\'Septembre\',10:\'Octobre\',11:\'Novembre\',12:\'D√©cembre\'};\nconst RATES={2020:1.141,2021:1.183,2022:1.053,2023:1.081,2024:1.085,2025:1.075,2026:1.04};\nfunction init(){const rc=document.getElementById(\'rates-container\');for(let y=2020;y<=2026;y++)rc.innerHTML+=`<div class="rate-row"><label>${y}</label><input type="number" id="rate-${y}" value="${RATES[y]||1.08}" step="0.001" min="0.5" max="3" onchange="refreshAll()"></div>`;}\nfunction getRate(y){const e=document.getElementById(`rate-${y}`);return e?parseFloat(e.value)||1.08:1.08;}\nfunction getRegime(){return document.querySelector(\'[name=regime]:checked\')?.value||\'pfu\';}\nfunction getTMI(){return parseInt(document.getElementById(\'tmi-select\')?.value||30)/100;}\nfunction onRegimeChange(){document.getElementById(\'tmi-row\').style.display=getRegime()===\'barem\'?\'block\':\'none\';refreshAll();}\nfunction onDrag(e){e.preventDefault();document.getElementById(\'drop-zone\').classList.add(\'drag\');}\nfunction onDrop(e){e.preventDefault();document.getElementById(\'drop-zone\').classList.remove(\'drag\');handleFiles(e.dataTransfer.files);}\nasync function handleFiles(files){\n  if(!files.length)return;\n  document.getElementById(\'welcome\').style.display=\'none\';document.getElementById(\'progress\').style.display=\'block\';\n  document.getElementById(\'dashboard\').style.display=\'none\';document.getElementById(\'year-tabs\').style.display=\'none\';\n  document.getElementById(\'debug-box\').style.display=\'none\';\n  const fd=new FormData();for(const f of files)fd.append(\'files\',f);\n  try{\n    const res=await fetch(\'/api/upload\',{method:\'POST\',body:fd});\n    const json=await res.json();\n    // Afficher le debug si des chiffres sont √† 0\n    const firstOk=json.statements[0];\n    if(firstOk && firstOk.st_net_period===0 && firstOk.total_market_value===0){\n      const db=document.getElementById(\'debug-box\');\n      db.style.display=\'block\';\n      db.textContent=\'‚ö†Ô∏è CHIFFRES √Ä Z√âRO ‚Äî Texte brut extrait par pdfplumber:\\n\\n\'+(firstOk._raw_preview||\'(vide)\');\n    }\n    processStatements(json.statements,json.errors);\n  }catch(e){document.getElementById(\'progress\').style.display=\'none\';alert(\'Erreur: \'+e.message);}\n}\nfunction processStatements(stmts,errors){\n  stmts.forEach(d=>{if(!state.allData[d.year])state.allData[d.year]={};state.allData[d.year][d.month.toLowerCase()]=d;});\n  document.getElementById(\'progress\').style.display=\'none\';document.getElementById(\'badge-count\').textContent=`${stmts.length} relev√©(s)`;\n  const sb=document.getElementById(\'status-bar\');sb.style.display=\'flex\';\n  sb.innerHTML=`<span class="status-tag ok">‚úÖ ${stmts.length} relev√©(s) analys√©(s)</span>`;\n  const years=Object.keys(state.allData).sort();\n  if(years.length)sb.innerHTML+=`<span class="status-tag ok">üìÖ Ann√©es: ${years.join(\', \')}</span>`;\n  if(errors.length)sb.innerHTML+=`<span class="status-tag err" title="${errors.map(e=>e.msg).join(\' | \')}">‚ö†Ô∏è ${errors.length} erreur(s)</span>`;\n  if(years.length){renderYearTabs();selectYear(parseInt(years[years.length-1]));}\n  else{document.getElementById(\'welcome\').style.display=\'block\';if(errors.length)alert(\'‚ùå \'+errors[0].msg);}\n}\nfunction renderYearTabs(){const yt=document.getElementById(\'year-tabs\');yt.style.display=\'flex\';yt.innerHTML=Object.keys(state.allData).sort().map(y=>`<div class="year-tab${parseInt(y)===state.currentYear?\' active\':\'\'}" onclick="selectYear(${y})">üìÖ ${y} (${Object.keys(state.allData[y]).length} mois)</div>`).join(\'\');}\nfunction selectYear(y){state.currentYear=y;renderYearTabs();document.getElementById(\'dashboard\').style.display=\'block\';refreshAll();}\nfunction refreshAll(){if(!state.currentYear)return;renderMonthly();renderAnnual();renderIFU();renderMulti();}\nfunction computeAnnual(yd,eur){\n  const months=Object.values(yd).sort((a,b)=>a.month_num-b.month_num);const dec=yd[\'december\'];\n  const pick=(ytd,per)=>dec?(dec[ytd]||0):months.reduce((s,m)=>s+(m[per]||0),0);\n  const d={st_gain:pick(\'st_gain_ytd\',\'st_gain_period\'),st_loss:pick(\'st_loss_ytd\',\'st_loss_period\'),st_net:pick(\'st_net_ytd\',\'st_net_period\'),lt_gain:pick(\'lt_gain_ytd\',\'lt_gain_period\'),lt_loss:pick(\'lt_loss_ytd\',\'lt_loss_period\'),lt_net:pick(\'lt_net_ytd\',\'lt_net_period\'),dividends:pick(\'dividend_ytd\',\'dividend_period\'),withholding:months.reduce((s,m)=>s+(m.withholding_tax_period||0),0)};\n  d.total_net=d.st_net+d.lt_net;Object.keys(d).forEach(k=>d[k+\'_eur\']=d[k]/eur);\n  const pv_pos=Math.max(0,d.total_net_eur);\n  if(getRegime()===\'pfu\'){d.tax_pv=pv_pos*.30;d.tax_div=d.dividends_eur*.30;d.regime_label=\'PFU 30%\';}\n  else{const tmi=getTMI(),ps=.172;d.tax_pv=pv_pos*(tmi+ps);d.tax_div=d.dividends_eur*.60*(tmi+ps);d.regime_label=`Bar√®me ${(tmi*100).toFixed(0)}%`;}\n  d.tax_total=d.tax_pv+d.tax_div;d.tax_credit=d.withholding_eur;d.tax_net=Math.max(0,d.tax_total-d.tax_credit);d.div_abat=d.dividends_eur*.60;return d;\n}\nconst fUSD=v=>`$${v.toLocaleString(\'fr-FR\',{minimumFractionDigits:2,maximumFractionDigits:2})}`;\nconst fEUR=v=>`${v.toLocaleString(\'fr-FR\',{minimumFractionDigits:2,maximumFractionDigits:2})} ‚Ç¨`;\nconst cls=v=>v>=0?\'pos\':\'neg\';const sign=v=>v>=0?\'+\':\'\';\nfunction mkChart(id,cfg){if(state.charts[id])state.charts[id].destroy();const ctx=document.getElementById(id)?.getContext(\'2d\');if(!ctx)return;Chart.defaults.color=\'#9fa8da\';Chart.defaults.borderColor=\'#2d3154\';state.charts[id]=new Chart(ctx,cfg);}\nfunction renderMonthly(){\n  const yd=state.allData[state.currentYear];const months=Object.values(yd).sort((a,b)=>a.month_num-b.month_num);const eur=getRate(state.currentYear);const ann=computeAnnual(yd,eur);\n  const labels=months.map(m=>MFR[m.month_num]||m.month);\n  document.getElementById(\'kpi-monthly\').innerHTML=`<div class="kpi green"><div class="label">PV Nettes (USD)</div><div class="value ${cls(ann.total_net)}">${sign(ann.total_net)}${fUSD(ann.total_net)}</div><div class="sub">CT + LT</div></div><div class="kpi ${ann.total_net_eur>=0?\'green\':\'red\'}"><div class="label">PV Nettes (EUR)</div><div class="value ${cls(ann.total_net_eur)}">${sign(ann.total_net_eur)}${fEUR(ann.total_net_eur)}</div><div class="sub">Taux ${eur.toFixed(3)}</div></div><div class="kpi orange"><div class="label">Dividendes (USD)</div><div class="value">${fUSD(ann.dividends)}</div><div class="sub">Bruts</div></div><div class="kpi"><div class="label">Portfolio</div><div class="value">${fUSD(months[months.length-1]?.total_market_value||0)}</div><div class="sub">${months.length} mois</div></div><div class="kpi red"><div class="label">Imp√¥t estim√©</div><div class="value">${fEUR(ann.tax_net)}</div><div class="sub">${ann.regime_label}</div></div>`;\n  const pvCT=months.map(m=>m.st_net_period),pvLT=months.map(m=>m.lt_net_period),pvTot=months.map(m=>m.total_net_period),divs=months.map(m=>m.dividend_period),ports=months.map(m=>m.total_market_value);\n  mkChart(\'chart-pv\',{type:\'bar\',data:{labels,datasets:[{label:\'PV CT\',data:pvCT,backgroundColor:pvCT.map(v=>v>=0?\'#43A047aa\':\'#E53935aa\'),borderWidth:1},{label:\'PV LT\',data:pvLT,backgroundColor:pvLT.map(v=>v>=0?\'#1E88E5aa\':\'#FB8C00aa\'),borderWidth:1},{label:\'Total net\',data:pvTot,type:\'line\',borderColor:\'#CE93D8\',borderWidth:2.5,tension:.3,fill:false,yAxisID:\'y\'}]},options:{responsive:true,interaction:{mode:\'index\'},plugins:{legend:{position:\'top\'}},scales:{y:{grid:{color:\'#2d3154\'}}}}});\n  mkChart(\'chart-div\',{type:\'bar\',data:{labels,datasets:[{label:\'Dividendes ($)\',data:divs,backgroundColor:\'#FFA726bb\'}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{grid:{color:\'#2d3154\'}}}}});\n  if(ports.some(v=>v>0))mkChart(\'chart-port\',{type:\'line\',data:{labels,datasets:[{label:\'Portfolio ($)\',data:ports,borderColor:\'#1565C0\',borderWidth:2.5,backgroundColor:\'rgba(21,101,192,.1)\',fill:true,tension:.3}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{grid:{color:\'#2d3154\'}}}}});\n  const eur2=getRate(state.currentYear);\n  document.getElementById(\'table-monthly\').innerHTML=`<tr><th>Mois</th><th>PV CT ($)</th><th>PV LT ($)</th><th>PV Total ($)</th><th>PV Total (‚Ç¨)</th><th>Dividendes ($)</th><th>Portfolio ($)</th></tr>`+months.map(m=>{const t=m.total_net_period,te=t/eur2;return`<tr><td>${MFULL[m.month_num]||m.month}</td><td class="${cls(m.st_net_period)}">${sign(m.st_net_period)}${fUSD(m.st_net_period)}</td><td class="${cls(m.lt_net_period)}">${sign(m.lt_net_period)}${fUSD(m.lt_net_period)}</td><td class="${cls(t)}">${sign(t)}${fUSD(t)}</td><td class="${cls(te)}">${sign(te)}${fEUR(te)}</td><td>${fUSD(m.dividend_period)}</td><td>${m.total_market_value>0?fUSD(m.total_market_value):\'‚Äî\'}</td></tr>`;}).join(\'\');\n}\nfunction renderAnnual(){\n  const yd=state.allData[state.currentYear];const eur=getRate(state.currentYear);const a=computeAnnual(yd,eur);\n  const src=yd[\'december\']?\'(YTD d√©cembre)\':\'(cumul mensuel)\';\n  const mkT=rows=>`<table class="data-table">${rows.map(([l,v,e])=>`<tr><td>${l}</td><td class="${cls(v)}">${sign(v)}${fUSD(v)}</td><td class="${cls(e)}">${sign(e)}${fEUR(e)}</td></tr>`).join(\'\')}</table>`;\n  const t=mkT([[\'Gains CT\',a.st_gain,a.st_gain_eur],[\'Pertes CT\',-a.st_loss,-a.st_loss_eur],[\'Net CT\',a.st_net,a.st_net_eur],[\'Gains LT\',a.lt_gain,a.lt_gain_eur],[\'Pertes LT\',-a.lt_loss,-a.lt_loss_eur],[\'Net LT\',a.lt_net,a.lt_net_eur],[\'‚Æû TOTAL\',a.total_net,a.total_net_eur],[\'Dividendes\',a.dividends,a.dividends_eur],[\'Retenue src.\',-a.withholding,-a.withholding_eur]]);\n  const p=`<p style="color:var(--muted);font-size:.8rem;margin-bottom:8px">Source: ${src}</p>`;\n  document.getElementById(\'annual-usd\').innerHTML=p+t;document.getElementById(\'annual-eur\').innerHTML=p+t;\n  const wfL=[\'Gains CT\',\'Pertes CT\',\'Net CT\',\'Gains LT\',\'Pertes LT\',\'Net LT\',\'Dividendes\'],wfV=[a.st_gain_eur,-a.st_loss_eur,a.st_net_eur,a.lt_gain_eur,-a.lt_loss_eur,a.lt_net_eur,a.dividends_eur];\n  mkChart(\'chart-waterfall\',{type:\'bar\',data:{labels:wfL,datasets:[{label:\'EUR\',data:wfV,backgroundColor:wfV.map(v=>v>=0?\'#43A047cc\':\'#E53935cc\')}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{grid:{color:\'#2d3154\'}}}}});\n}\nfunction renderIFU(){\n  const yd=state.allData[state.currentYear];const eur=getRate(state.currentYear);const a=computeAnnual(yd,eur);const y=state.currentYear;\n  const pv3VG=Math.max(0,a.total_net_eur),pv3VH=Math.max(0,-a.total_net_eur);const barem=getRegime()===\'barem\';\n  document.getElementById(\'ifu-cards\').innerHTML=`<div class="ifu-card"><h4>üìà Plus-values mobili√®res</h4><div class="ifu-row"><span>PV CT nettes</span><span class="${cls(a.st_net_eur)}">${sign(a.st_net_eur)}${fEUR(a.st_net_eur)}</span></div><div class="ifu-row"><span>PV LT nettes</span><span class="${cls(a.lt_net_eur)}">${sign(a.lt_net_eur)}${fEUR(a.lt_net_eur)}</span></div><div class="ifu-row"><span>Total PV nettes</span><span class="${cls(a.total_net_eur)}">${sign(a.total_net_eur)}${fEUR(a.total_net_eur)}</span></div></div><div class="ifu-card"><h4>üí∞ Revenus mobiliers</h4><div class="ifu-row"><span>Dividendes bruts</span><span>${fEUR(a.dividends_eur)}</span></div><div class="ifu-row"><span>Retenue source 15%</span><span class="neg">-${fEUR(a.withholding_eur)}</span></div><div class="ifu-row"><span>Dividendes nets</span><span>${fEUR(a.dividends_eur-a.withholding_eur)}</span></div></div><div class="ifu-card"><h4>üèõÔ∏è Imp√¥t (${a.regime_label})</h4><div class="ifu-row"><span>Sur PV</span><span>${fEUR(a.tax_pv)}</span></div><div class="ifu-row"><span>Sur dividendes</span><span>${fEUR(a.tax_div)}</span></div><div class="ifu-row"><span>Total brut</span><span>${fEUR(a.tax_total)}</span></div><div class="ifu-row"><span>Cr√©dit √©tranger</span><span class="neg">-${fEUR(a.tax_credit)}</span></div><div class="ifu-row"><span>üî¥ NET √Ä PAYER</span><span class="neg">${fEUR(a.tax_net)}</span></div></div>`;\n  document.getElementById(\'formulaires\').innerHTML=`<div class="formulaire"><h5>üìÑ Formulaire 2042-C</h5><div class="form-row"><span>Case <span class="form-case">3VG</span></span><span>${fEUR(pv3VG)}</span></div><div class="form-row"><span>Case <span class="form-case">3VH</span></span><span>${fEUR(pv3VH)}</span></div><div class="form-row"><span>Case <span class="form-case">2DC</span></span><span>${fEUR(a.dividends_eur)}</span></div><div class="form-row"><span>Case <span class="form-case">2AB</span></span><span>${fEUR(a.withholding_eur)}</span></div>${barem?`<div class="form-row"><span><span class="form-case">2BH</span></span><span>${fEUR(a.dividends_eur)}</span></div><div class="form-row"><span><span class="form-case">2DA</span></span><span>${fEUR(a.div_abat)}</span></div>`:\'\'}</div><div class="formulaire"><h5>üìÑ Formulaire 2047</h5><div class="form-row"><span>Sect. IV ‚Äì Dividendes</span><span>${fEUR(a.dividends_eur)}</span></div><div class="form-row"><span>Cr√©dit imp√¥t</span><span>${fEUR(a.withholding_eur)}</span></div><div class="form-row"><span>Sect. V ‚Äì PV</span><span class="${cls(a.total_net_eur)}">${fEUR(a.total_net_eur)}</span></div></div><div class="formulaire"><h5>üìÑ Formulaire 3916 ‚ö†Ô∏è</h5><div class="form-row"><span>√âtablissement</span><span>Alpaca Securities LLC</span></div><div class="form-row"><span>Pays</span><span>üá∫üá∏ √âtats-Unis</span></div><div class="form-row"><span>Obligation</span><span style="color:#EF9A9A">Annuelle obligatoire</span></div></div>`;\n  const months=Object.values(yd).sort((a,b)=>a.month_num-b.month_num);\n  const csv=[\'Mois;PV_CT_USD;PV_LT_USD;PV_Total_USD;PV_CT_EUR;PV_LT_EUR;PV_Total_EUR;Dividendes_USD;Dividendes_EUR;RetenueSrc_USD;Portfolio_USD\',...months.map(m=>[MFULL[m.month_num]||m.month,m.st_net_period,m.lt_net_period,m.total_net_period,(m.st_net_period/eur).toFixed(2),(m.lt_net_period/eur).toFixed(2),(m.total_net_period/eur).toFixed(2),m.dividend_period,(m.dividend_period/eur).toFixed(2),m.withholding_tax_period,m.total_market_value].join(\';\'))].join(\'\\n\');\n  document.getElementById(\'export-bar\').innerHTML=`<button class="btn btn-success" onclick="dlTxt(\'IFU_${y}_Alpaca.txt\',buildIFU())">üì• T√©l√©charger IFU (.txt)</button><button class="btn btn-outline" onclick="dlCsv(\'Alpaca_${y}.csv\',\\`${csv}\\`)">üìä T√©l√©charger CSV</button>`;\n}\nfunction buildIFU(){const yd=state.allData[state.currentYear];const eur=getRate(state.currentYear);const a=computeAnnual(yd,eur);const y=state.currentYear;const pv3VG=Math.max(0,a.total_net_eur),pv3VH=Math.max(0,-a.total_net_eur);return`R√âCAPITULATIF FISCAL ${y} ‚Äî ALPACA\\nTaux EUR/USD: ${eur.toFixed(3)} | R√©gime: ${a.regime_label}\\n\\nPLUS-VALUES\\nNet CT: ${fUSD(a.st_net)} / ${fEUR(a.st_net_eur)}\\nNet LT: ${fUSD(a.lt_net)} / ${fEUR(a.lt_net_eur)}\\nTOTAL: ${fUSD(a.total_net)} / ${fEUR(a.total_net_eur)}\\n\\nDIVIDENDES: ${fUSD(a.dividends)} / ${fEUR(a.dividends_eur)}\\nRETENUE 15%: -${fEUR(a.withholding_eur)}\\n\\nFISCALIT√â\\nImp√¥t PV: ${fEUR(a.tax_pv)}\\nImp√¥t Div: ${fEUR(a.tax_div)}\\nNET √Ä PAYER: ${fEUR(a.tax_net)}\\n\\nCASES 2042-C\\n3VG: ${fEUR(pv3VG)} | 3VH: ${fEUR(pv3VH)}\\n2DC: ${fEUR(a.dividends_eur)} | 2AB: ${fEUR(a.withholding_eur)}\\n\\n‚ö†Ô∏è Document indicatif.`;}\nfunction dlTxt(name,c){const a=document.createElement(\'a\');a.href=URL.createObjectURL(new Blob([c],{type:\'text/plain\'}));a.download=name;a.click();}\nfunction dlCsv(name,c){const a=document.createElement(\'a\');a.href=URL.createObjectURL(new Blob([c],{type:\'text/csv\'}));a.download=name;a.click();}\nfunction renderMulti(){\n  const years=Object.keys(state.allData).map(Number).sort();if(!years.length)return;\n  const rows=years.map(y=>({y,a:computeAnnual(state.allData[y],getRate(y))}));\n  mkChart(\'chart-multi\',{type:\'bar\',data:{labels:rows.map(r=>String(r.y)),datasets:[{label:\'PV nettes (‚Ç¨)\',data:rows.map(r=>r.a.total_net_eur),backgroundColor:\'#1E88E5bb\'},{label:\'Dividendes (‚Ç¨)\',data:rows.map(r=>r.a.dividends_eur),backgroundColor:\'#FFA726bb\'},{label:\'Imp√¥t net (‚Ç¨)\',data:rows.map(r=>r.a.tax_net),backgroundColor:\'#E53935bb\'}]},options:{responsive:true,interaction:{mode:\'index\'},plugins:{legend:{position:\'top\'}},scales:{y:{grid:{color:\'#2d3154\'}}}}});\n  document.getElementById(\'table-multi\').innerHTML=`<tr><th>Ann√©e</th><th>PV nettes ($)</th><th>PV nettes (‚Ç¨)</th><th>Dividendes (‚Ç¨)</th><th>Retenue (‚Ç¨)</th><th>Net √† payer (‚Ç¨)</th></tr>`+rows.map(({y,a})=>`<tr><td><strong>${y}</strong></td><td class="${cls(a.total_net)}">${sign(a.total_net)}${fUSD(a.total_net)}</td><td class="${cls(a.total_net_eur)}">${sign(a.total_net_eur)}${fEUR(a.total_net_eur)}</td><td>${fEUR(a.dividends_eur)}</td><td class="neg">-${fEUR(a.withholding_eur)}</td><td class="neg"><strong>${fEUR(a.tax_net)}</strong></td></tr>`).join(\'\');\n}\nfunction showTab(name,e){document.querySelectorAll(\'.tab\').forEach(t=>t.classList.remove(\'active\'));document.querySelectorAll(\'.tab-content\').forEach(t=>t.classList.remove(\'active\'));e.target.classList.add(\'active\');document.getElementById(\'tab-\'+name).classList.add(\'active\');}\nfunction resetApp(){if(!confirm(\'R√©initialiser?\'))return;state.allData={};state.currentYear=null;Object.values(state.charts).forEach(c=>c.destroy());state.charts={};document.getElementById(\'welcome\').style.display=\'block\';document.getElementById(\'dashboard\').style.display=\'none\';document.getElementById(\'year-tabs\').style.display=\'none\';document.getElementById(\'status-bar\').style.display=\'none\';document.getElementById(\'debug-box\').style.display=\'none\';document.getElementById(\'badge-count\').textContent=\'0 relev√©(s)\';document.getElementById(\'file-input\').value=\'\';}\ninit();\n</script></body></html>'

from fastapi import FastAPI, UploadFile, File
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse
import pdfplumber, re, io
from typing import List

app = FastAPI(title="Alpaca Tax Analyzer")
app.add_middleware(CORSMiddleware, allow_origins=["*"], allow_methods=["*"], allow_headers=["*"])

MONTH_MAP = {
    "JANUARY":1,"FEBRUARY":2,"MARCH":3,"APRIL":4,"MAY":5,"JUNE":6,
    "JULY":7,"AUGUST":8,"SEPTEMBER":9,"OCTOBER":10,"NOVEMBER":11,"DECEMBER":12
}

def pn(s):
    try: return float(str(s).replace(",","").replace(" ",""))
    except: return 0.0

def extract_full_text(pdf_bytes: bytes) -> str:
    parts = []
    with pdfplumber.open(io.BytesIO(pdf_bytes)) as pdf:
        for page in pdf.pages:
            # extract_words retourne les mots avec positions X/Y
            # On les trie par ligne (Y) puis par colonne (X) = ordre de lecture naturel
            try:
                words = page.extract_words(x_tolerance=5, y_tolerance=5)
                if words:
                    sorted_words = sorted(words, key=lambda w: (round(float(w["top"])/5)*5, float(w["x0"])))
                    parts.append(" ".join(w["text"] for w in sorted_words))
                    continue
            except Exception:
                pass
            # Fallback : extract_text classique
            t = page.extract_text() or ""
            parts.append(t.replace("\n", " "))
    return " ".join(parts)

def parse_pdf(content: bytes) -> dict:
    r = dict(period=None, year=None, month=None, month_num=None,
             total_market_value=0.0,
             dividend_period=0.0, dividend_ytd=0.0,
             st_gain_period=0.0, st_gain_ytd=0.0,
             st_loss_period=0.0, st_loss_ytd=0.0,
             st_net_period=0.0,  st_net_ytd=0.0,
             lt_gain_period=0.0, lt_gain_ytd=0.0,
             lt_loss_period=0.0, lt_loss_ytd=0.0,
             lt_net_period=0.0,  lt_net_ytd=0.0,
             withholding_tax_period=0.0,
             total_net_period=0.0, total_net_ytd=0.0)

    txt = extract_full_text(content)
    r["_raw_preview"] = txt[:400]

    if len(txt.strip()) < 20:
        r["debug_text"] = "PDF illisible ou vide"
        return r

    # DATE
    m = re.search(
        r"(JANUARY|FEBRUARY|MARCH|APRIL|MAY|JUNE|JULY|AUGUST|SEPTEMBER|OCTOBER|NOVEMBER|DECEMBER)"
        r"[^\d]*(20[012]\d)",
        txt[:1500], re.I
    )
    if m:
        mo, yr = m.group(1).upper(), int(m.group(2))
        r.update(period=f"{mo} {yr}", year=yr, month=mo, month_num=MONTH_MAP.get(mo, 0))
    else:
        r["debug_text"] = txt[:300]
        return r

    # TOTAL MARKET VALUE
    m = re.search(r"Total Market Value\s+([\d,]+\.?\d*)", txt)
    if m: r["total_market_value"] = pn(m.group(1))

    # DIVIDENDES
    m = re.search(r"Income Summary.*?Dividend\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)", txt)
    if m:
        r["dividend_period"] = pn(m.group(1))
        r["dividend_ytd"]    = pn(m.group(2))

    # REALIZED GAIN/LOSS
    m_block = re.search(
        r"Realized Gain.?Loss from Sales(.*?)(?:FDIC|Holdings|Income Trade)",
        txt, re.DOTALL | re.I
    )
    if m_block:
        block = m_block.group(1)
        mg = re.search(r"Short Term Gain\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)", block)
        if mg: r["st_gain_period"], r["st_gain_ytd"] = pn(mg.group(1)), pn(mg.group(2))
        ml = re.search(r"Short Term Gain.*?Loss\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)", block, re.DOTALL)
        if ml: r["st_loss_period"], r["st_loss_ytd"] = pn(ml.group(1)), pn(ml.group(2))
        mn = re.search(r"Short Term Gain.*?Net\s+(-?[\d,]+\.?\d*)\s+(-?[\d,]+\.?\d*)", block, re.DOTALL)
        if mn: r["st_net_period"], r["st_net_ytd"] = pn(mn.group(1)), pn(mn.group(2))
        mg2 = re.search(r"Long Term Gain\s+(-?[\d,]+\.?\d*|--)\s+(-?[\d,]+\.?\d*|--)", block)
        if mg2:
            r["lt_gain_period"] = 0.0 if "--" in mg2.group(1) else pn(mg2.group(1))
            r["lt_gain_ytd"]    = 0.0 if "--" in mg2.group(2) else pn(mg2.group(2))
        m_lt = re.search(
            r"Long Term Gain.*?Loss\s+([\d,]+\.?\d*|--)\s+([\d,]+\.?\d*|--).*?Net\s+(-?[\d,]+\.?\d*)\s+(-?[\d,]+\.?\d*)",
            block, re.DOTALL
        )
        if m_lt:
            r["lt_loss_period"] = pn(m_lt.group(1))
            r["lt_loss_ytd"]    = pn(m_lt.group(2))
            r["lt_net_period"]  = pn(m_lt.group(3))
            r["lt_net_ytd"]     = pn(m_lt.group(4))

    # RETENUE A LA SOURCE
    wt_vals = re.findall(r"AdjNRA Withheld[^-]*(-[\d,]+\.?\d*)", txt)
    r["withholding_tax_period"] = sum(abs(pn(v)) for v in wt_vals)

    r["total_net_period"] = r["st_net_period"] + r["lt_net_period"]
    r["total_net_ytd"]    = r["st_net_ytd"]    + r["lt_net_ytd"]
    return r

@app.get("/")
async def get_index():
    return HTMLResponse(content=HTML_CONTENT)

@app.post("/api/upload")
async def upload(files: List[UploadFile] = File(...)):
    ok, err = [], []
    for f in files:
        try:
            d = parse_pdf(await f.read())
            if d.get("year") and d.get("month_num"):
                ok.append(d)
            else:
                err.append({
                    "file": f.filename,
                    "msg": f"Date introuvable. Preview: {d.get('debug_text') or d.get('_raw_preview','(vide)')}"
                })
        except Exception as e:
            import traceback
            err.append({"file": f.filename, "msg": traceback.format_exc()})
    return {"statements": ok, "errors": err}

@app.get("/api/debug")
async def debug_info():
    import pdfplumber as plumb
    return {"pdfplumber_version": plumb.__version__, "status": "ok"}
